# Railway Deployment Guide for MemVault Backend

## Prerequisites
- GitHub account
- Railway account (sign up at https://railway.app)
- Your MemVault repository pushed to GitHub

## Step-by-Step Deployment

### 1. Create Railway Account
1. Go to https://railway.app
2. Click "Login" and sign in with GitHub
3. Authorize Railway to access your GitHub repositories

### 2. Create New Project
1. Click "New Project" on Railway dashboard
2. Select "Deploy from GitHub repo"
3. Choose your `MemVault` repository
4. Railway will automatically detect your backend

### 3. Add PostgreSQL Database
1. In your project, click "New Service"
2. Select "Database"
3. Choose "PostgreSQL"
4. Railway will automatically provision a database
5. Note: Railway will auto-generate `DATABASE_URL` variable

### 4. Configure Environment Variables

Click on your backend service → "Variables" tab and add these:

#### Required Variables:
```bash
# Database (Auto-generated by Railway - DO NOT SET MANUALLY)
DATABASE_URL=postgresql://user:pass@host:port/dbname

# App Configuration
ENVIRONMENT=production
SECRET_KEY=your-super-secret-key-min-32-chars
ALLOWED_ORIGINS=https://your-frontend.vercel.app,http://localhost:3000

# OpenAI (for AI features)
OPENAI_API_KEY=sk-your-openai-api-key

# ElevenLabs (for voice cloning)
ELEVENLABS_API_KEY=your-elevenlabs-api-key

# IPFS/Pinata (for file storage)
PINATA_API_KEY=your-pinata-api-key
PINATA_SECRET_KEY=your-pinata-secret-key

# Redis (Optional - add Redis service if needed)
REDIS_URL=redis://default:password@host:port

# CORS
BACKEND_CORS_ORIGINS=["https://your-frontend.vercel.app","http://localhost:3000"]
```

#### Optional Variables:
```bash
# Feature Flags
ENABLE_VOICE_CLONING=true
ENABLE_IPFS_STORAGE=true

# Logging
LOG_LEVEL=INFO

# Rate Limiting
RATE_LIMIT_ENABLED=true
```

### 5. Configure Build Settings
1. Click on your service → "Settings" tab
2. Ensure these settings:
   - **Root Directory**: `packages/backend`
   - **Build Command**: (leave empty - uses Dockerfile)
   - **Start Command**: `uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2`

### 6. Deploy
1. Railway will automatically deploy after you add variables
2. Wait for deployment to complete (check "Deployments" tab)
3. Once deployed, click on your service to get the public URL
4. Copy the URL (e.g., `https://your-app.railway.app`)

### 7. Run Database Migrations
Railway will automatically run migrations through the Dockerfile.
If you need to run them manually:

1. Go to your service → "Settings" → "Deploy"
2. Add a custom start command:
   ```bash
   alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2
   ```

### 8. Test Your Deployment
Visit your Railway URL + `/docs` to see the API documentation:
```
https://your-app.railway.app/docs
```

### 9. Update Frontend Environment Variables
Update your Vercel frontend environment variables:
```bash
NEXT_PUBLIC_API_URL=https://your-app.railway.app
```

Redeploy your frontend on Vercel.

## Monitoring & Logs

### View Logs
1. Click on your service
2. Go to "Deployments" tab
3. Click on the latest deployment
4. View real-time logs

### Metrics
Railway provides built-in metrics:
- CPU usage
- Memory usage
- Network traffic
- Request count

## Troubleshooting

### Deployment Failed
- Check build logs in "Deployments" tab
- Verify all environment variables are set
- Ensure `DATABASE_URL` is connected to PostgreSQL service

### Database Connection Issues
- Verify PostgreSQL service is running
- Check `DATABASE_URL` format: `postgresql://user:pass@host:port/dbname`
- Try restarting the service

### Port Binding Issues
- Railway uses `$PORT` environment variable
- Ensure your app binds to `0.0.0.0` not `localhost`
- Verify Dockerfile uses `$PORT`

### Migration Errors
- Check database connection
- Manually run migrations from Railway CLI:
  ```bash
  railway run alembic upgrade head
  ```

## Cost Estimation

Railway Pricing:
- **Hobby Plan**: $5/month (500 hours of usage)
- **Developer Plan**: $10/month (1000 hours + priority support)
- Database storage is included

## Additional Services (Optional)

### Add Redis
1. Click "New Service" → "Database" → "Redis"
2. Copy `REDIS_URL` to environment variables

### Add Custom Domain
1. Go to "Settings" → "Domains"
2. Add your custom domain
3. Update DNS records as instructed

## Security Best Practices

1. **Use Secrets**: Never commit API keys to Git
2. **Environment Variables**: Always use Railway's Variables feature
3. **HTTPS Only**: Railway provides HTTPS by default
4. **CORS**: Restrict `ALLOWED_ORIGINS` to your frontend domain
5. **Database**: Use Railway's internal networking for DB connections

## Useful Commands

### Railway CLI (Optional)
Install Railway CLI for advanced features:
```bash
npm i -g @railway/cli
railway login
railway link
railway run alembic upgrade head
railway logs
```

## Next Steps

After successful deployment:
1. ✅ Test all API endpoints
2. ✅ Update frontend to use Railway URL
3. ✅ Set up monitoring alerts
4. ✅ Configure custom domain (optional)
5. ✅ Set up CI/CD for automatic deployments

## Support

- Railway Docs: https://docs.railway.app
- Railway Discord: https://discord.gg/railway
- GitHub Issues: Your repository issues page
